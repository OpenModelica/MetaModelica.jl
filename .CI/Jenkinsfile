pipeline {
  agent {
    docker {
      label 'linux'
      image 'julia:1.2-buster'
      alwaysPull  true
      args '--privileged'
    }
  }
  options {
    skipDefaultCheckout true
  }
  stages {
    stage('build') {
      environment {
        USER = 'jenkins'
      }
      steps {
        dir("MetaModelica.jl") {
          checkout scm
          sh '(pwd)'
          sh '''
          export HOME=$PWD
          julia -e "using Pkg;
          Pkg.add(test/\"ExportAll\\");
          Pkg.add(test/\\"DataStructures\\");
          Pkg.add(test/\\"MacroTools\\");
          Pkg.add(test/\\"Test\\");
          Pkg.add(PackageSpec(url=\\"https://github.com/OpenModelica/ImmutableList.jl\\"))"
          '''
          sh 'export HOME=$PWD; julia -e "using Pkg; Pkg.REPLMode.pkgstr(\\"add $PWD\\")"'
          sh 'export HOME=$PWD; julia -e "using Pkg; Pkg.status()"'
          sh 'export HOME=$PWD; julia -e "using Pkg; Pkg.test(\\"MetaModelica\\", coverage=true)"'
        }
      }
    }
  }
}
